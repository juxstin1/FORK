# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What Is FORK

FORK is an AI-native framework for building and shipping mobile apps. It combines a production-ready React Native/Expo app with an MCP (Model Context Protocol) server that gives AI agents direct control over the codebase. Users describe what they want, and FORK orchestrates: IDEA → DESIGN → BUILD → TEST → DEBUG → SHIP.

The current demo app in `App.tsx` is **Glyph Pet**, a Nothing-aesthetic Tamagotchi game generated by the BUILD stage.

## Commands

All commands run from the `app/` directory:

```bash
npm install          # Install dependencies
npm run start        # Expo dev server
npm run web          # Run in browser
npm run ios          # Run on iOS simulator
npm run android      # Run on Android emulator
npm run mcp          # Start the MCP server (tsx src/server/index.ts)
npm run dev          # Development launcher (node scripts/dev.js)
```

There is no test runner or linter configured. TypeScript strict mode is the primary safety net.

## Architecture

### Two Halves: Brain + Body

**Brain** (`app/src/server/index.ts`) — An MCP server using `@modelcontextprotocol/sdk` over stdio. Exposes tools to Claude: `get_prompt`, `run_idea_stage`, `run_design_stage`, `run_build_stage`, `read_files`, `run_docker`. The server resolves `projectDir` as `path.resolve(process.cwd(), "..")` — it assumes it runs from `app/`.

**Body** (`app/`) — A standard Expo app with React Native 0.81, NativeWind (Tailwind), Zustand state, and Supabase backend.

### Pipeline Stages (`app/src/stages/`)

Each stage is a standalone module with a `run*Stage()` function:

- **idea.ts** — Takes raw idea text + budget → detects budget tier, infers platforms, checks feature/budget conflicts, writes `requirements.md` and `features.json` to `.rork/`
- **design.ts** — Takes a DesignSpec JSON → saves to `.rork/design.json`
- **build.ts** — Takes an array of `{path, content}` file objects → writes code files to the project with safe directory creation
- **persona.ts** — Takes requirements → classifies app category, runs web research, generates diverse user personas (primary + secondary + edge-case)
- **read.ts** — Reads file contents with security checks
- **docker.ts** — Executes Docker commands for infrastructure

### Budget-First Architecture (`app/src/lib/budget.ts`)

User declares monthly spend and the system picks the tech stack:

| Tier | Budget | Database | Auth | Storage | Build |
|------|--------|----------|------|---------|-------|
| free | $0 | supabase-free | supabase | r2-free | eas-free |
| starter | ≤$25 | supabase-pro | supabase | r2 | eas-production |
| pro | ≤$50 | supabase-pro | clerk | r2-cdn | eas-ota |
| scale | >$50 | planetscale | clerk-pro | r2-edge | eas-full |

### Prompt Registry (`app/src/lib/prompts/`)

All prompts are centralized in `REGISTRY` in `index.ts` — no inline prompts allowed. Each prompt has an ID (`stage.action.version`), system/user templates, tags, and token limits. Templates use `{{variable}}` substitution via `render.ts`. Access prompts only through `getPrompt()`, `renderPrompt()`, or `getRenderedPrompt()`.

Available prompt IDs: `idea.generate.v1`, `idea.refine.v1`, `idea.conflict.v1`, `persona.generate.v1`, `persona.research.v1`, `persona.validate.v1`, `design.generate.v1`, `build.screen.v1`, `build.component.v1`.

### Supporting Libraries (`app/src/lib/`)

- **context/** — Token counting, budget allocation, and context compression
- **memory/** — Persistent memory storage and retrieval across sessions
- **evaluation/** — A/B testing and quality metrics logging
- **idea/** — Feature generation, conflict detection, platform inference, requirements writer
- **persona/** — Category classification, web research, persona generation with default fallbacks

### State Management (`app/src/stores/app.ts`)

Zustand store tracking: current project, loading state, errors, and stage progression.

### Type System (`app/src/types/`)

- **rork.ts** — `RorkProject`, `BudgetTier`, `TierConfig`, `Stage` (INIT|IDEA|DESIGN|BUILD|TEST|DEBUG|SHIP)
- **idea.ts** — `Feature`, `Requirements`, `TargetUser`, `Conflict`
- **persona.ts** — `Persona`, `PersonaSet`, `TechProfile`

### AI Metadata (`.rork/`)

The `.rork/` directory stores AI-generated artifacts: `project.json`, `features.json`, `requirements.md`, `design.json`. This is the AI's working memory for the current project.

## Tech Stack

- **Expo** ~54 / **React Native** 0.81 / **React** 19.1
- **NativeWind** 4.2 (Tailwind CSS via `className`)
- **Zustand** 5 for state
- **Supabase** for backend
- **Zod** 4 for runtime validation
- **MCP SDK** 1.26 for server protocol
- **TypeScript** ~5.9 (strict mode)

## Key Conventions

- Prompts go in the registry (`lib/prompts/`), never inline
- Stage functions are the only entry points for pipeline operations
- Budget tier drives all infrastructure decisions — respect the tier constraints
- `.rork/` is the AI's scratchpad; code goes in `app/` proper
- The MCP server uses stdio transport and expects to run from `app/`
