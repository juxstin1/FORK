# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What Is FORK

FORK is an AI-native framework for building and shipping mobile apps. It combines a production-ready React Native/Expo app with an MCP (Model Context Protocol) server that gives AI agents direct control over the codebase. Users describe what they want, and FORK orchestrates: IDEA → PERSONA → DESIGN → BUILD → TEST → DEBUG → SHIP.

The current demo app in `App.tsx` is **Glyph Pet**, a Nothing-aesthetic Tamagotchi game generated by the BUILD stage.

## Commands

All commands run from the `app/` directory:

```bash
npm install          # Install dependencies
npm run start        # Expo dev server
npm run web          # Run in browser
npm run ios          # Run on iOS simulator
npm run android      # Run on Android emulator
npm run mcp          # Start the MCP server (tsx src/server/index.ts)
npm run dev          # Development launcher (Expo + preview server)
npm run preview      # Preview server only (port 3333)
```

There is no test runner or linter configured. TypeScript strict mode is the primary safety net.

## Preview System

`npm run dev` starts Expo on port 8081 and a preview server on port 3333. The preview shows the app inside a CSS iPhone 15 Pro frame with device switching (SE/15/Pro Max), rotate, and reload controls.

The `capture_preview` MCP tool uses Puppeteer to take headless screenshots of the running app, returning base64 PNG images at 2x retina resolution.

| Service | URL |
|---------|-----|
| Expo | http://localhost:8081 |
| Preview | http://localhost:3333 |

## Architecture

### Two Halves: Brain + Body

**Brain** (`app/src/server/index.ts`) — An MCP server using `@modelcontextprotocol/sdk` over stdio. Exposes 14 tools to Claude including pipeline stages, file operations, preview capture, design/build generation, and external LLM delegation. The server resolves `projectDir` as `path.resolve(process.cwd(), "..")` — it assumes it runs from `app/`.

**Body** (`app/`) — A standard Expo app with React Native 0.81, NativeWind (Tailwind), Zustand state, and Supabase backend.

### Pipeline Stages (`app/src/stages/`)

Each stage is a standalone module with a `run*Stage()` function:

- **idea.ts** — Takes raw idea text + budget → detects budget tier, infers platforms, checks feature/budget conflicts, writes `requirements.md` and `features.json` to `.rork/`
- **persona.ts** — Reads IDEA output → classifies app category, runs web research, generates diverse user personas (primary + secondary + edge-case), auto-advances project stage to DESIGN
- **design.ts** — Takes a DesignSpec JSON → saves to `.rork/design.json`
- **design-generator.ts** — Reads upstream artifacts, renders `design.generate.v2` prompt, calls OpenRouter, parses JSON into DesignSpec, saves via `runDesignStage()`
- **build.ts** — Takes an array of `{path, content}` file objects → writes code files to the project with safe directory creation
- **build-generator.ts** — Reads design.json, generates screen/component code via OpenRouter using v2 prompts, writes files, runs validation
- **build-validator.ts** — Post-build static analysis (regex-based): checks for missing exports, inline styles, `any` types, missing SafeAreaView, console.log, hardcoded colors
- **read.ts** — Reads file contents with path validation security checks
- **docker.ts** — Executes Docker commands for infrastructure

### MCP Server Tools (14 total)

| Tool | Purpose |
|------|---------|
| `get_prompt` | Retrieve prompt from registry by ID |
| `run_idea_stage` | Process raw idea + budget → requirements |
| `run_persona_stage` | Generate personas from IDEA requirements |
| `run_design_stage` | Save design specification |
| `run_design_generate` | Generate DesignSpec from upstream artifacts via OpenRouter |
| `run_build_stage` | Write generated code files |
| `run_build_generate` | Generate code from design.json via OpenRouter + validate |
| `read_files` | Read project files (with security) |
| `run_docker` | Execute Docker commands |
| `grep_project` | Search file contents by regex |
| `list_files` | List files matching glob patterns |
| `get_project_summary` | Full project context in one call |
| `run_openrouter` | Delegate to external LLMs (GPT, Qwen, etc.) |
| `capture_preview` | Screenshot the running app (Puppeteer, base64 PNG) |

### Budget-First Architecture (`app/src/lib/budget.ts`)

User declares monthly spend and the system picks the tech stack:

| Tier | Budget | Database | Auth | Storage | Build |
|------|--------|----------|------|---------|-------|
| free | $0 | supabase-free | supabase | r2-free | eas-free |
| starter | ≤$25 | supabase-pro | supabase | r2 | eas-production |
| pro | ≤$50 | supabase-pro | clerk | r2-cdn | eas-ota |
| scale | >$50 | planetscale | clerk-pro | r2-edge | eas-full |

### Prompt Registry (`app/src/lib/prompts/`)

All prompts are centralized in `REGISTRY` in `index.ts` — no inline prompts allowed. Each prompt has an ID (`stage.action.version`), system/user templates, tags, and token limits. Templates use `{{variable}}` substitution via `render.ts`. Access prompts only through `getPrompt()`, `renderPrompt()`, or `getRenderedPrompt()`.

**v1 Prompt IDs:** `idea.generate.v1`, `idea.refine.v1`, `idea.conflict.v1`, `persona.generate.v1`, `persona.research.v1`, `persona.validate.v1`, `design.generate.v1`, `build.screen.v1`, `build.component.v1`

**v2 Prompt IDs:** `design.generate.v2` (persona-driven, budget-aware), `build.screen.v2` (NativeWind/typed/strict), `build.component.v2` (NativeWind/typed/strict)

v2 prompts enforce: NativeWind className (no StyleSheet), TypeScript strict (no `any`), SafeAreaView on screens, Zustand store patterns, proper import conventions.

### Artifact Reader (`app/src/lib/artifacts.ts`)

Shared utility for reading `.rork/` upstream artifacts:
- `readFeatures(projectDir)` → `Feature[] | null`
- `readPersonas(projectDir)` → `PersonaSet | null`
- `readDesign(projectDir)` → `DesignSpec | null`
- `readProjectConfig(projectDir)` → `RorkProject | null`
- `readRequirements(projectDir)` → `string | null`

### Supporting Libraries (`app/src/lib/`)

- **context/** — Token counting, budget allocation, and context compression
- **memory/** — Persistent memory storage and retrieval across sessions
- **evaluation/** — A/B testing and quality metrics logging
- **idea/** — Feature generation, conflict detection, platform inference, requirements writer
- **persona/** — Category classification, web research, persona generation with default fallbacks

### State Management (`app/src/stores/app.ts`)

Zustand store tracking: current project, loading state, errors, and stage progression. Stage transitions also happen inside stage functions (e.g., persona stage updates `project.json` stage field to "DESIGN").

### Type System (`app/src/types/`)

- **rork.ts** — `RorkProject`, `BudgetTier`, `TierConfig`, `Stage` (INIT|IDEA|PERSONA|DESIGN|BUILD|TEST|DEBUG|SHIP)
- **idea.ts** — `Feature`, `Requirements`, `TargetUser`, `Conflict`
- **persona.ts** — `Persona`, `PersonaSet`, `TechProfile`

### AI Metadata (`.rork/`)

The `.rork/` directory stores AI-generated artifacts: `project.json`, `features.json`, `requirements.md`, `design.json`. This is the AI's working memory for the current project.

### Project Planning (`.planning/`)

- `STATE.md` — Current milestone, phase, and progress table
- `TODOS.md` — Strict-format task tracker (see TODO Format below)
- `ROADMAP.md` — Full milestone plan (10 phases for MVP Pipeline)
- `PROJECT.md` — Vision, requirements, architecture
- `phases/` — Per-phase documentation (plans, research, summaries)

### Slash Commands (`.claude/commands/fork/`)

Pipeline operations available as `/fork:*` commands:

| Command | Stage | Description |
|---------|-------|-------------|
| `/fork:app-init` | Setup | Create app directory, Expo scaffold, FORK scaffolding |
| `/fork:idea` | IDEA | Process raw idea → requirements + features |
| `/fork:persona` | PERSONA | Generate data-backed user personas |
| `/fork:design` | DESIGN | Generate design spec via `run_design_generate` |
| `/fork:build` | BUILD | Generate code via `run_build_generate` |
| `/fork:preview` | Utility | Capture app screenshot via `capture_preview` |
| `/fork:simulate` | SIMULATE | AI user testing with personas |
| `/fork:test` | TEST | Generate and run tests |
| `/fork:debug` | DEBUG | Analyze failures, generate fixes |
| `/fork:ship` | SHIP | App Store submission package |
| `/fork:dev` | Utility | Start Expo + preview server |
| `/fork:status` | Utility | Show pipeline progress |
| `/fork:mcp` | Utility | Start MCP server |
| `/fork:pipeline` | Orchestrator | Run full pipeline from current stage |
| `/fork:todo-add` | Task | Add todo with auto-ID |
| `/fork:todo-start` | Task | Mark todo in-progress by ID |
| `/fork:todo-done` | Task | Complete todo, unblock dependents |
| `/fork:todo-block` | Task | Block todo, record blocker |
| `/fork:todos` | Task | List open/in-progress todos |

### Skill Files (`.claude/skills/`)

Behavioral pattern docs for Claude Code:
- `pipeline-stages.md` — How each stage works
- `mcp-server.md` — Server tools, resources, and patterns
- `prompt-registry.md` — Prompt system conventions
- `budget-tiers.md` — Budget-first architecture decisions
- `project-state.md` — How to read/update project state
- `preview-system.md` — Preview server, screenshot tool, dev launcher

## Tech Stack

- **Expo** ~54 / **React Native** 0.81 / **React** 19.1
- **NativeWind** 4.2 (Tailwind CSS via `className`)
- **Zustand** 5 for state
- **Supabase** for backend
- **Zod** 4 for runtime validation
- **MCP SDK** 1.26 for server protocol
- **Puppeteer** 24 for preview screenshots (devDependency)
- **TypeScript** ~5.9 (strict mode)

## Key Conventions

- Prompts go in the registry (`lib/prompts/`), never inline
- Stage functions are the only entry points for pipeline operations
- Budget tier drives all infrastructure decisions — respect the tier constraints
- `.rork/` is the AI's scratchpad; code goes in `app/` proper
- The MCP server uses stdio transport and expects to run from `app/`
- Update `.planning/STATE.md` and `TODOS.md` after completing work
- Persona stage sits between IDEA and DESIGN in the pipeline
- Use v2 prompts for generation (`design.generate.v2`, `build.screen.v2`, `build.component.v2`)

## TODO Format

Single source of truth: `.planning/TODOS.md`. Strict line contract:

```
- [status] #ID P{0-3} created:YYYY-MM-DD [meta...] — description
```

- Status: `[ ]` open, `[>]` in-progress, `[x]` done, `[-]` blocked
- ID: `#` + 3-digit zero-padded (`#001`, `#042`)
- Meta: `started:date`, `done:date`, `owner:name`, `tags:a,b`, `blockedBy:#ID`
- `Next ID:` counter in file header — always increment after adding
- Completed items move to `## Done` section
- Completing a blocker auto-unblocks its dependents
